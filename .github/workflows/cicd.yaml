name: CI/CD (Docker + Helm + Blue/Green)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Image/Chart tag to deploy (default = current run number)"
        required: false

env:
  # ===== HARD-CODED INFRA =====
  ACR_NAME: bestrongacr123
  ACR_LOGIN: bestrongacr123.azurecr.io
  AKS_NAME: bestrong-aks
  AKS_RG: BeStrongTeam01

  # ===== PROJECT =====
  TF_DIR: terraform
  IMAGE_NAME: dotnet-crud-api
  APP_CHART_DIR: helm-charts/bestrong-app
  ROUTE_CHART_DIR: helm-charts/bestrong-routing
  HELM_REPO: helm
  TAG: ${{ github.run_number }}

  # ===== DEPLOY =====
  APP_ID: bestrong-api
  APP_CHART: bestrong-app
  ROUTE_CHART: bestrong-routing
  ROUTE_RELEASE: bestrong-routing

  # auth azure
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.vars.outputs.tag }}
      chart_version: ${{ steps.vars.outputs.chart_version }}
    steps:
      - name: Set TAG
        id: vars
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.run_number }}"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "chart_version=0.1.$TAG" >> "$GITHUB_OUTPUT"

  # ===== OPTIONAL: Terraform =====
  # terraform:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: azure/login@v2
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - uses: hashicorp/setup-terraform@v3
  #     - name: Terraform apply
  #       working-directory: ${{ env.TF_DIR }}
  #       run: |
  #         terraform init -input=false
  #         terraform apply -auto-approve -input=false

  # docker:
  #   runs-on: ubuntu-latest
  #   # needs: terraform
  #   outputs:
  #     tag: ${{ steps.vars.outputs.tag }}
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set TAG
  #       id: vars
  #       run: |
  #         if [ -n "${{ inputs.tag }}" ]; then
  #           echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
  #         else
  #           echo "tag=${{ github.run_number }}" >> "$GITHUB_OUTPUT"
  #         fi

  #     - name: Azure login (service principal)
  #       run: |
  #         az login \
  #           --service-principal \
  #           -u "$AZURE_CLIENT_ID" \
  #           -p "$AZURE_CLIENT_SECRET" \
  #           --tenant "$AZURE_TENANT_ID"

  #         az account set \
  #           --subscription "$AZURE_SUBSCRIPTION_ID"

  #     - name: Set up QEMU
  #       uses: docker/setup-qemu-action@v3
  #       with:
  #         platforms: arm64

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Build & push (ARM64)
  #       run: |
  #         az acr login --name "$ACR_NAME"

  #         docker buildx build \
  #           --platform linux/arm64 \
  #           -t $ACR_LOGIN/$IMAGE_NAME:$TAG \
  #           -f app/Dockerfile \
  #           --push .


  helm:
    runs-on: ubuntu-latest
    # needs: terraform
    needs: vars
    steps:
      - uses: actions/checkout@v4

      - name: Set CHART_VERSION
        id: vars
        run: |
          TAG="${{ needs.vars.outputs.tag }}"

          echo "chart_version=0.1.${TAG}" >> "$GITHUB_OUTPUT"

      - name: Azure login (service principal)
        run: |
          az login \
            --service-principal \
            -u "$AZURE_CLIENT_ID" \
            -p "$AZURE_CLIENT_SECRET" \
            --tenant "$AZURE_TENANT_ID"

          az account set \
            --subscription "$AZURE_SUBSCRIPTION_ID"

      - name: Install Helm
        run: |
          curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Helm package & push (OCI â†’ ACR)
        env:
          TAG: ${{ needs.vars.outputs.tag }}
          CHART_VERSION: ${{ steps.vars.outputs.chart_version }}
        run: |
          TOKEN=$(az acr login --name "$ACR_NAME" \
            --expose-token --query accessToken -o tsv)

          helm registry login "$ACR_LOGIN" \
            -u 00000000-0000-0000-0000-000000000000 \
            -p "$TOKEN"

          helm package "$APP_CHART_DIR" \
            --version "$CHART_VERSION" \
            --app-version "$TAG"

          helm package "$ROUTE_CHART_DIR" \
            --version "$CHART_VERSION" \
            --app-version "$TAG"

          ls -la *.tgz

          helm push bestrong-app-*.tgz \
            oci://$ACR_LOGIN/$HELM_REPO

          helm push bestrong-routing-*.tgz \
            oci://$ACR_LOGIN/$HELM_REPO

  deploy:
    runs-on: ubuntu-latest
    needs: [vars, helm]
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (service principal)
        run: |
          az login \
            --service-principal \
            -u "$AZURE_CLIENT_ID" \
            -p "$AZURE_CLIENT_SECRET" \
            --tenant "$AZURE_TENANT_ID"

          az account set \
            --subscription "$AZURE_SUBSCRIPTION_ID"

      - name: Install Helm + jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Set vars
        run: |
          echo "TAG=${{ needs.vars.outputs.tag }}" >> $GITHUB_ENV
          echo "CHART_VERSION=${{ needs.vars.outputs.chart_version }}" >> $GITHUB_ENV

      - name: Connect to AKS
        run: |
          az aks get-credentials \
            -g "$AKS_RG" \
            -n "$AKS_NAME" \
            --overwrite-existing

      - name: Helm login to ACR (OCI)
        run: |
          TOKEN=$(az acr login --name "$ACR_NAME" \
            --expose-token --query accessToken -o tsv)

          helm registry login "$ACR_LOGIN" \
            -u 00000000-0000-0000-0000-000000000000 \
            -p "$TOKEN"

      - name: Bootstrap if empty
        run: |
          set -e

          if ! helm status "$ROUTE_RELEASE" >/dev/null 2>&1; then
            echo "Bootstrap: BLUE + routing"

            helm upgrade --install bestrong-blue \
              oci://$ACR_LOGIN/$HELM_REPO/$APP_CHART \
              --version "$CHART_VERSION" \
              --set appId=$APP_ID \
              --set color=blue \
              --set image.repository=$ACR_LOGIN/$IMAGE_NAME \
              --set image.tag=10

            helm upgrade --install "$ROUTE_RELEASE" \
              oci://$ACR_LOGIN/$HELM_REPO/$ROUTE_CHART \
              --version "$CHART_VERSION" \
              --set appId=$APP_ID \
              --set activeColor=blue

            exit 0
          fi

      - name: Compute next color
        run: |
          ACTIVE=$(helm get values "$ROUTE_RELEASE" -o json | jq -r '.activeColor')
          if [ "$ACTIVE" = "blue" ]; then NEXT=green; else NEXT=blue; fi
          echo "NEXT=$NEXT" >> $GITHUB_ENV
          echo "Active=$ACTIVE Next=$NEXT"

      - name: Deploy next color
        run: |
          helm upgrade --install bestrong-$NEXT \
            oci://$ACR_LOGIN/$HELM_REPO/$APP_CHART \
            --version "$CHART_VERSION" \
            --set appId=$APP_ID \
            --set color=$NEXT \
            --set image.repository=$ACR_LOGIN/$IMAGE_NAME \
            --set image.tag=10

      - name: Switch traffic
        run: |
          helm upgrade "$ROUTE_RELEASE" \
            oci://$ACR_LOGIN/$HELM_REPO/$ROUTE_CHART \
            --version "$CHART_VERSION" \
            --reuse-values \
            --set activeColor=$NEXT