name: CI/CD (Docker + Helm + Blue/Green)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Image/Chart tag to deploy (default = current run number)"
        required: false

env:
  # ===== HARD-CODED INFRA =====
  ACR_NAME: testdrivemegacr
  ACR_LOGIN: testdrivemegacr.azurecr.io
  AKS_NAME: testdrive-aks
  AKS_RG: test-rg-bg

  # ===== PROJECT =====
  TF_DIR: terraform
  IMAGE_NAME: dotnet-crud-api
  APP_CHART_DIR: helm-charts/bestrong-app
  ROUTE_CHART_DIR: helm-charts/bestrong-routing
  HELM_REPO: helm

  # ===== DEPLOY =====
  APP_ID: bestrong-api
  APP_CHART: bestrong-app
  ROUTE_CHART: bestrong-routing
  ROUTE_RELEASE: bestrong-routing

jobs:
  # ===== OPTIONAL: Terraform =====
  # terraform:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: azure/login@v2
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - uses: hashicorp/setup-terraform@v3
  #     - name: Terraform apply
  #       working-directory: ${{ env.TF_DIR }}
  #       run: |
  #         terraform init -input=false
  #         terraform apply -auto-approve -input=false

  docker:
    runs-on: ubuntu-latest
    # needs: terraform
    outputs:
      tag: ${{ steps.vars.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set TAG
        id: vars
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.run_number }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker build & push
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          az acr login --name "$ACR_NAME"

          docker build \
            -t $ACR_LOGIN/$IMAGE_NAME:$TAG \
            -f app/Dockerfile .

          docker push $ACR_LOGIN/$IMAGE_NAME:$TAG

  helm:
    runs-on: ubuntu-latest
    # needs: terraform
    needs: docker
    outputs:
      chart_version: ${{ steps.vars.outputs.chart_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Set CHART_VERSION
        id: vars
        run: |
          TAG="${{ needs.docker.outputs.tag }}"
          echo "chart_version=0.1.${TAG}" >> "$GITHUB_OUTPUT"

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Helm
        run: |
          curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Helm package & push (OCI â†’ ACR)
        env:
          TAG: ${{ needs.docker.outputs.tag }}
          CHART_VERSION: ${{ steps.vars.outputs.chart_version }}
        run: |
          TOKEN=$(az acr login --name "$ACR_NAME" \
            --expose-token --query accessToken -o tsv)

          helm registry login "$ACR_LOGIN" \
            -u 00000000-0000-0000-0000-000000000000 \
            -p "$TOKEN"

          helm package "$APP_CHART_DIR" \
            --version "$CHART_VERSION" \
            --app-version "$TAG"

          helm package "$ROUTE_CHART_DIR" \
            --version "$CHART_VERSION" \
            --app-version "$TAG"

          ls -la *.tgz

          helm push bestrong-app-*.tgz \
            oci://$ACR_LOGIN/$HELM_REPO

          helm push bestrong-routing-*.tgz \
            oci://$ACR_LOGIN/$HELM_REPO

  deploy:
    runs-on: ubuntu-latest
    needs: [docker, helm]
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install tools
        run: |
          curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          az aks install-cli
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Set vars
        run: |
          echo "TAG=${{ needs.docker.outputs.tag }}" >> $GITHUB_ENV
          echo "CHART_VERSION=${{ needs.helm.outputs.chart_version }}" >> $GITHUB_ENV

      - name: Connect to AKS
        run: |
          az aks get-credentials \
            -g "$AKS_RG" \
            -n "$AKS_NAME" \
            --overwrite-existing

      - name: Helm login to ACR (OCI)
        run: |
          TOKEN=$(az acr login --name "$ACR_NAME" \
            --expose-token --query accessToken -o tsv)

          helm registry login "$ACR_LOGIN" \
            -u 00000000-0000-0000-0000-000000000000 \
            -p "$TOKEN"

      - name: Bootstrap if empty
        run: |
          set -e

          if ! helm status "$ROUTE_RELEASE" >/dev/null 2>&1; then
            echo "Bootstrap: BLUE + routing"

            helm upgrade --install bestrong-blue \
              oci://$ACR_LOGIN/$HELM_REPO/$APP_CHART \
              --version "$CHART_VERSION" \
              --set appId=$APP_ID \
              --set color=blue \
              --set image.repository=$ACR_LOGIN/$IMAGE_NAME \
              --set image.tag=$TAG

            helm upgrade --install "$ROUTE_RELEASE" \
              oci://$ACR_LOGIN/$HELM_REPO/$ROUTE_CHART \
              --version "$CHART_VERSION" \
              --set appId=$APP_ID \
              --set activeColor=blue

            exit 0
          fi

      - name: Compute next color
        run: |
          ACTIVE=$(helm get values "$ROUTE_RELEASE" -o json | jq -r '.activeColor')
          if [ "$ACTIVE" = "blue" ]; then NEXT=green; else NEXT=blue; fi
          echo "NEXT=$NEXT" >> $GITHUB_ENV
          echo "Active=$ACTIVE Next=$NEXT"

      - name: Deploy next color
        run: |
          helm upgrade --install bestrong-$NEXT \
            oci://$ACR_LOGIN/$HELM_REPO/$APP_CHART \
            --version "$CHART_VERSION" \
            --set appId=$APP_ID \
            --set color=$NEXT \
            --set image.repository=$ACR_LOGIN/$IMAGE_NAME \
            --set image.tag=$TAG

      - name: Switch traffic
        run: |
          helm upgrade "$ROUTE_RELEASE" \
            oci://$ACR_LOGIN/$HELM_REPO/$ROUTE_CHART \
            --version "$CHART_VERSION" \
            --reuse-values \
            --set activeColor=$NEXT