# BeStrong Infrastructure & Deployment

![Azure](https://img.shields.io/badge/azure-%230072C6.svg?style=for-the-badge&logo=microsoftazure&logoColor=white)
![Terraform](https://img.shields.io/badge/terraform-%235835CC.svg?style=for-the-badge&logo=terraform&logoColor=white)
![Kubernetes](https://img.shields.io/badge/kubernetes-%23326ce5.svg?style=for-the-badge&logo=kubernetes&logoColor=white)
![Helm](https://img.shields.io/badge/helm-%230F1689.svg?style=for-the-badge&logo=helm&logoColor=white)

This repository contains the **Infrastructure as Code (IaC)** and **CI/CD Configuration** for the "BeStrong" API application.

It is designed to provision a production-ready Azure Kubernetes Service (AKS) cluster and implements a **Blue-Green Deployment Strategy** to ensure zero-downtime updates.

---

## Architecture Overview

* **Cloud Provider:** Microsoft Azure
* **Orchestrator:** Azure Kubernetes Service (AKS)
* **IaC Tool:** Terraform
* **Package Manager:** Helm
* **CI/CD:** GitHub Actions
* **Deployment Strategy:** Blue-Green (Team 1)

### Blue-Green Strategy
We utilize a traffic-switching approach:
1.  **Blue (Live):** The stable version currently serving user traffic.
2.  **Green (Idle):** The new version deployed alongside Blue for testing.
3.  **The Switch:** An Ingress configuration update instantly routes traffic from Blue to Green.

---

## Prerequisites

To run this project locally, you need:
* [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
* [Terraform](https://www.terraform.io/downloads)
* [Kubectl](https://kubernetes.io/docs/tasks/tools/)
* [Helm](https://helm.sh/docs/intro/install/)

---

## Getting Started

### 1. Provision Infrastructure (Terraform)
Initialize and apply the Terraform configuration to create the AKS cluster and ACR.

```bash
# Login to Azure
az login

# Initialize Terraform
cd terraform
terraform init

# Apply Configuration
terraform apply -var="resource_group_name=bestrong-rg" -var="location=germanywestcentral"

```

### 2. Working with Kubernetes and Helm
Here's some essential commands, that you would need to get to work with your AKS cluster and Helm 

Connect to the AKS cluster:
```
az aks get-credentials --resource-group bestrong-rg --name bestrong-aks
```

Verify cluster access:
```
kubectl cluster-info
kubectl get nodes
```

Create a dedicated production namespace:
```
kubectl create namespace production
```

Deploy or upgrade the application via Helm:
```
helm upgrade --install bestrong-api ./helm/bestrong-api \
  -n production \
  --create-namespace
```

Check pod status:
```
kubectl get pods -n production
kubectl describe pod <pod-name> -n production
```

View application logs:
```
kubectl logs -f deployment/bestrong-api -n production
```

View application logs:
```
kubectl logs -f deployment/bestrong-api -n production
```

---

### 1. Setup CI/CD with your ACR

1. Make changes in your workflow file `.github/workflows/<your_pipeline>.yml`:
   - Update ACR/AKS envs:
     - **ACR_NAME** → your ACR name (without `.azurecr.io`)
     - **ACR_LOGIN** → your login server (`<acr>.azurecr.io`)
     - **AKS_NAME** → your AKS cluster name
     - **AKS_RG** → your AKS resource group

2. GitHub Secrets (Settings → Secrets and variables → Actions)
   - Create secrets:
     - `AZURE_CLIENT_ID`
     - `AZURE_CLIENT_SECRET`
     - `AZURE_TENANT_ID`

---

### 2. Setup HTTPS

Make changes in these files:

1. `k8s-infra/cluster-wide/clusterissuer-letsencrypt.yaml`
   - Put your email and AzureDNS information in corresponding fields

2. `k8s-infra/certificates/bestrong-tls.yaml`
   - Change `dnsNames` to your domain
   - Also update other certificates in that folder if using Grafana or OpenCost

3. `helm-charts/bestrong-app/values.yaml`
   - Change `host` in ingress to your domain

---

### 3. Setup Prometheus and Grafana
1. `k8s-infra\helm-values\grafana-values.yaml`
   - Change hosts to your domain

2. Accesing Grafana
   1. Username: admin
   2. Password: autogenerated - get it with command
   ```bash
   kubectl get secret -n monitoring monitoring-grafana -o jsonpath="{.data.admin-password}" | base64 -d
   ```
   Or set your own password with:
   ```bash
   kubectl create secret generic grafana-admin \
     -n monitoring \
     --from-literal=admin-user=admin \
     --from-literal=admin-password=YourStrongPassword
   ```


### 3. Setup Prometheus and Grafana
1. `k8s-infra\helm-values\grafana-values.yaml`
   - Change hosts to your domain

2. Accesing Grafana
   1. Username: admin
   2. Password: autogenerated - get it with command
   ```bash
   kubectl get secret -n monitoring monitoring-grafana -o jsonpath="{.data.admin-password}" | base64 -d
   ```
   Or set your own password with:
   ```bash
   kubectl create secret generic grafana-admin \
     -n monitoring \
     --from-literal=admin-user=admin \
     --from-literal=admin-password=YourStrongPassword
   ```
   and add to grafana-values.yaml:
   ```
    grafana.admin.existingSecret: grafana-admin
    grafana.admin.userKey: admin-user
    grafana.admin.passwordKey: admin-password
   ```

### 4. Setup OpenCost: Cost allocation and Cloud costs:
1. Azure Pricing Configuration:
   - Create a Custom Azure role:
   myrole.json
   ```
      {
       "Name": "OpenCostRole",
       "IsCustom": true,
       "Description": "Rate Card query role",
       "Actions": [
           "Microsoft.Compute/virtualMachines/vmSizes/read",
           "Microsoft.Resources/subscriptions/locations/read",
           "Microsoft.Resources/providers/read",
           "Microsoft.ContainerService/containerServices/read",
           "Microsoft.Commerce/RateCard/read"
       ],
       "AssignableScopes": [
           "/subscriptions/YOUR_SUBSCRIPTION_ID"
       ]
   }
   ```
   ```bash
   az role definition create --verbose --role-definition @myrole.json
   ```
   - Create an Azure Service Principal
   ```az ad sp create-for-rbac --name "OpenCostAccess" --role "OpenCostRole" --scope "/subscriptions/YOUR_SUBSCRIPTION_ID" --output json```

   - Supply Azure Service Principal details to OpenCost
   service-key.json
   ```
      {
       "subscriptionId": "<Azure Subscription ID>",
       "serviceKey": {
           "appId": "<Azure AD App ID>",
           "displayName": "OpenCostAccess",
           "password": "<Azure AD Client Secret>",
           "tenant": "<Azure AD Tenant ID>"
          }
      }
   ```
   ```bash
   kubectl create secret generic azure-service-key -n opencost --from-file=service-key.json
   ```

2. Azure Cloud Costs
   cloud-integration.json
   ```
      {
     "azure": {
       "storage": [
         {
           "subscriptionID": "<SUBSCRIPTON_ID>",
           "account": "<STORAGE_ACCOUNT>",
           "container": "<STORAGE_CONTAINER>",
           "path": "<CONTAINER_PATH>",
           "cloud": "<CLOUD>",
           "authorizer": {
             "accessKey": "<STORAGE_ACCESS_KEY>",
             "account": "<STORAGE_ACCOUNT>",
             "authorizerType": "AzureAccessKey"
           }
         },
         {
           "subscriptionID": "<SUBSCRIPTION_ID>",
           "account": "<STORAGE_ACCOUNT>",
           "container": "<EXPORT_CONTAINER>",
           "path": "",
           "cloud": "<CLOUD>",
           "authorizer": {
             "accessKey": "<ACCOUNT_ACCESS_KEY>",
             "account": "<STORAGE_ACCOUNT>",
             "authorizerType": "AzureAccessKey"
           }
         }
       ]
     }
   }
   ```

   ```
   kubectl create secret generic cloud-costs --from-file=./cloud-integration.json --namespace opencost
   ```
3.  Authorization via Traefik Middleware
  - Create a password:
    `htpasswd -nb admin <YourPassword>`
     Example output:
       `admin:$apr1$kjsdhf$kjsdhfksjdhfksjdhf`
  
  - Create secret
  ```
  kubectl create secret generic opencost-auth \
    -n opencost \
    --from-literal=users='YOUR_OUTPUT_HERE'
  ```
